name: Build

on: [push, pull_request]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Install dependencies
        run: |
          brew install ldid xz automake libtool pkg-config coreutils

      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git "$HOME/theos"
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH
          
          # Fixed iOS 13.0 SDK URL
          mkdir -p "$HOME/theos/sdks"
          curl -L -O https://github.com/theos/sdks/archive/refs/heads/master.zip
          unzip master.zip
          mv sdks-master/iPhoneOS13.0.sdk.tar.xz .
          unxz iPhoneOS13.0.sdk.tar.xz
          tar xvf iPhoneOS13.0.sdk.tar -C "$HOME/theos/sdks"

      - name: Build libplist
        run: |
          cd libplist
          ./autogen.sh
          export SDKROOT="$HOME/theos/sdks/iPhoneOS13.0.sdk"
          ./configure --host=arm-apple-darwin --prefix="$PWD/install" \
            CC="clang -isysroot $SDKROOT -arch arm64 -arch arm64e" \
            CXX="clang++ -isysroot $SDKROOT -arch arm64 -arch arm64e"
          make
          make install
          echo "LIBPLIST_INCLUDE=$PWD/install/include" >> $GITHUB_ENV
          echo "LIBPLIST_LIB=$PWD/install/lib" >> $GITHUB_ENV

      - name: Build tweak
        run: |
          export TARGET_CFLAGS="-I$LIBPLIST_INCLUDE"
          export TARGET_LDFLAGS="-L$LIBPLIST_LIB -lplist"
          make package