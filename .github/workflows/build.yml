name: Build Jailbreak Tweak (Rootless)

on:
  workflow_dispatch:
    inputs:
      sdk-version:
        description: 'iOS SDK versions (comma separated)'
        required: false
        default: 'iPhoneOS13.7.sdk'
  push:
    branches: [master]

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
    - name: Install dependencies
      run: |
        brew install ldid dpkg make coreutils
        # Add GNU make to PATH
        echo "/opt/homebrew/opt/make/libexec/gnubin" >> $GITHUB_PATH
        
    - name: Install Xcode Command Line Tools
      run: |
        sudo xcode-select --install || true
        sudo xcode-select --switch /Applications/Xcode_15.4.app/Contents/Developer
        
    - name: Select Xcode version
      run: |
        sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
        
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Theos
      run: |
        export THEOS=~/theos
        [ -d "$THEOS" ] || git clone --recursive https://github.com/theos/theos.git "$THEOS"
        echo "THEOS=$THEOS" >> $GITHUB_ENV
        echo "$THEOS/bin" >> $GITHUB_PATH

    - name: Set up iOS SDK
      run: |
        SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
        SDK_NAME="iPhoneOS13.7.sdk"
        mkdir -p "${HOME}/theos/sdks"
        ln -s "${SDK_PATH}" "${HOME}/theos/sdks/${SDK_NAME}"
        echo "SDKROOT=${HOME}/theos/sdks/${SDK_NAME}" >> $GITHUB_ENV

    - name: Setup OpenCV
      run: |
        mkdir -p "${HOME}/theos/opencv-ios-sdk"
        curl -L -o "${HOME}/theos/opencv-ios-framework.zip" \
          https://github.com/opencv/opencv/releases/download/4.8.0/opencv-4.8.0-ios-framework.zip
        unzip -q "${HOME}/theos/opencv-ios-framework.zip" -d "${HOME}/theos"
        
        # Reorganize OpenCV headers
        FRAMEWORK_PATH="${HOME}/theos/opencv2.framework"
        HEADERS_PATH="${FRAMEWORK_PATH}/Headers"
        OPENCV2_HEADERS_PATH="${HEADERS_PATH}/opencv2"
        mkdir -p "${OPENCV2_HEADERS_PATH}"
        shopt -s extglob
        mv ${HEADERS_PATH}/!(opencv2) "${OPENCV2_HEADERS_PATH}" 2>/dev/null || true
        shopt -u extglob
        mv "${FRAMEWORK_PATH}" "${HOME}/theos/opencv-ios-sdk/"

        echo "OpenCV_INCLUDE_DIR=${HOME}/theos/opencv-ios-sdk/opencv2.framework/Headers" >> $GITHUB_ENV

    - name: Prepare build environment
      run: |
        sudo mkdir -p /usr/local/include
        sudo ln -s "${HOME}/theos/opencv-ios-sdk/opencv2.framework/Headers" /usr/local/include/opencv2 || true
        
        echo "TARGET=iphone:clang:13.7:9.0" >> $GITHUB_ENV
        echo "ARCHS=arm64" >> $GITHUB_ENV
        echo "THEOS_PACKAGE_SCHEME=rootless" >> $GITHUB_ENV
        echo "FINALPACKAGE=1" >> $GITHUB_ENV

    - name: Patch BKUserEventTimer.h
      run: |
        sed -i '' 's/#define _Bool BOOL/\/\/ #define _Bool BOOL/' pccontrol/headers/BKUserEventTimer.h

    - name: Create patching script
      run: |
        cat > patch_zxtouch.sh << 'EOS'
        #!/bin/bash
        set -e
        
        # Fix 1: Replace 'system' with posix_spawn
        sed -i '' 's/return system(\[\[NSString stringWithFormat:@"%@", parameterArr\[2\]\] UTF8String\]);/return execute_posix_command(parameterArr[2]);/g' zxtouch-binary/main.mm
        
        # Fix 2: Add necessary headers and function declaration
        cat << "EOF" > temp_patch.mm
        #include <Foundation/Foundation.h>
        #include <spawn.h>
        #include <sys/wait.h>
        #include <stdio.h>
        #include <string.h>
        #include <signal.h>
        
        extern char **environ;
        
        int execute_posix_command(NSString *command);
        EOF
        
        # Insert after existing includes
        sed -i '' '/#include/r temp_patch.mm' zxtouch-binary/main.mm
        rm temp_patch.mm
        
        # Fix 3: Add function implementation
        cat << "EOF" >> zxtouch-binary/main.mm
        
        int execute_posix_command(NSString *command) {
            pid_t pid;
            const char *cmd = [command UTF8String];
            char *const argv[] = {(char *)"sh", (char *)"-c", (char *)cmd, NULL};
            posix_spawnattr_t attr;
            
            posix_spawnattr_init(&attr);
            posix_spawnattr_setflags(&attr, POSIX_SPAWN_SETSIGDEF | POSIX_SPAWN_SETSIGMASK);
            sigset_t all_signals;
            sigfillset(&all_signals);
            posix_spawnattr_setsigmask(&attr, &all_signals);
            sigemptyset(&all_signals);
            posix_spawnattr_setsigdefault(&attr, &all_signals);
            
            int status = posix_spawn(&pid, "/bin/sh", NULL, &attr, argv, environ);
            if (status == 0) {
                if (waitpid(pid, &status, 0) == -1) {
                    perror("waitpid");
                }
            } else {
                NSLog(@"posix_spawn failed: %s", strerror(status));
            }
            posix_spawnattr_destroy(&attr);
            return status;
        }
        EOF
        
        # Fix 4: Remove unused variable
        sed -i '' 's/int sock = 0, valread;/int sock = 0;/g' zxtouch-binary/main.mm
        
        # Fix 5: Remove unsupported arm64e
        sed -i '' 's/ARCHS = armv7 arm64 arm64e/ARCHS = arm64/g' zxtouch-binary/Makefile
        
        # Fix 6: Add missing imports in main file
        sed -i '' '1i\
        #import <Foundation/Foundation.h>\
        #import <signal.h>
        ' zxtouch-binary/main.mm
        EOS
        chmod +x patch_zxtouch.sh
    
    - name: Patch zxtouch-binary
      run: ./patch_zxtouch.sh

    - name: Patch appdelegate Tweak.xm
      run: |
        # Add necessary include for strcmp()
        sed -i '' $'1i\\\n#include <string.h>' appdelegate/Tweak.xm
        
        # Fix deprecated conversion warning
        sed -i '' 's|return "/System/Library/PrivateFrameworks/CertUI.framework/CertUIA";|return (char*)"/System/Library/PrivateFrameworks/CertUI.framework/CertUIA";|' appdelegate/Tweak.xm

    - name: Debug file content
      run: |
        # Check if files exist first
        if [ -f zxtouch-binary/main.mm ]; then
            echo "main.mm content:"
            head -n 20 zxtouch-binary/main.mm
        else
            echo "Error: main.mm not found!"
            exit 1
        fi
        
        if [ -f zxtouch-binary/Makefile ]; then
            echo "Makefile ARCHS setting:"
            grep -i "archs" zxtouch-binary/Makefile || echo "ARCHS not found in Makefile"
        else
            echo "Error: Makefile not found!"
            exit 1
        fi

    - name: Build package
      run: |
        make clean
        make package VERBOSE=1 \
          THEOS="${THEOS}" \
          SDKROOT="${SDKROOT}" \
          OpenCV_INCLUDE_DIR="${OpenCV_INCLUDE_DIR}" \
          FINALPACKAGE="${FINALPACKAGE}" \
          THEOS_PACKAGE_SCHEME="${THEOS_PACKAGE_SCHEME}"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: IOS13-SimulateTouch
        path: packages/*.deb