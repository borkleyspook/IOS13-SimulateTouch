name: Build Jailbreak Tweak (Rootless)

on:
  workflow_dispatch:
    inputs:
      sdk-version:
        description: 'iOS SDK versions (comma separated)'
        required: false
        default: 'iPhoneOS13.7.sdk'
  push:
    branches: [master]

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
    - name: Install dependencies
      run: |
        brew install ldid dpkg make coreutils
        
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Theos
      run: |
        git clone --recursive https://github.com/theos/theos.git "${HOME}/theos"
        echo "THEOS=${HOME}/theos" >> $GITHUB_ENV
        echo "${HOME}/theos/bin" >> $GITHUB_PATH

    - name: Install iOS SDK
      run: |
        mkdir -p "${HOME}/theos/sdks"
        
        # Download SDK
        SDK_NAME="iPhoneOS13.7.sdk"
        curl -L -o "${HOME}/theos/sdks/${SDK_NAME}.tar.xz" \
          https://github.com/theos/sdks/releases/download/master-146e41f/${SDK_NAME}.tar.xz
        
        # Extract SDK
        tar -xJf "${HOME}/theos/sdks/${SDK_NAME}.tar.xz" -C "${HOME}/theos/sdks"
        
        # Verify extraction
        [ -d "${HOME}/theos/sdks/${SDK_NAME}" ] || { 
          echo "❌ SDK extraction failed!";
          exit 1;
        }
        
        echo "SDKROOT=${HOME}/theos/sdks/${SDK_NAME}" >> $GITHUB_ENV

    - name: Setup OpenCV
      run: |
        mkdir -p "${HOME}/theos/opencv-ios-sdk"
        curl -L -o "${HOME}/theos/opencv-ios-framework.zip" \
          https://github.com/opencv/opencv/releases/download/4.5.1/opencv-4.5.1-ios-framework.zip
        unzip -q "${HOME}/theos/opencv-ios-framework.zip" -d "${HOME}/theos"

        # Reorganize OpenCV headers for proper inclusion
        FRAMEWORK_PATH="${HOME}/theos/opencv2.framework"
        HEADERS_PATH="${FRAMEWORK_PATH}/Headers"
        OPENCV2_HEADERS_PATH="${HEADERS_PATH}/opencv2"

        mkdir -p "${OPENCV2_HEADERS_PATH}"

        shopt -s extglob
        mv ${HEADERS_PATH}/!(opencv2) "${OPENCV2_HEADERS_PATH}" 2>/dev/null || true
        shopt -u extglob

        mv "${FRAMEWORK_PATH}" "${HOME}/theos/opencv-ios-sdk/"

        echo "OpenCV_INCLUDE_DIR=${HOME}/theos/opencv-ios-sdk/opencv2.framework/Headers" >> $GITHUB_ENV

    - name: Prepare build environment
      run: |
        # Create OpenCV include directory
        sudo mkdir -p /usr/local/include/opencv2
        sudo ln -s "${HOME}/theos/opencv-ios-sdk/opencv2.framework/Headers/opencv2" /usr/local/include/opencv2 || true
        
        # Set build parameters
        echo "TARGET=iphone:clang:13.7:9.0" >> $GITHUB_ENV
        echo "ARCHS=arm64" >> $GITHUB_ENV
        echo "THEOS_PACKAGE_SCHEME=rootless" >> $GITHUB_ENV
        echo "FINALPACKAGE=1" >> $GITHUB_ENV

    - name: Verify repository structure
      run: |
        echo "Repository content:"
        ls -la
        [ -d "appdelegate" ] && echo "✅ appdelegate found"
        [ -d "layout" ] && echo "✅ layout found"
        [ -d "pccontrol" ] && echo "✅ pccontrol found"

    # ... previous steps ...

    - name: Create patching script
      run: |
        cat > patch_zxtouch.sh << 'EOS'
        #!/bin/bash
        set -e

        # Fix 1: Replace 'system' with posix_spawn
        sed -i '' 's/return system(\[\[NSString stringWithFormat:@"%@", parameterArr\[2\]\] UTF8String\]);/return execute_posix_command(parameterArr[2]);/g' zxtouch-binary/main.mm
        
        # Fix 2: Add necessary headers and function declaration
        cat << "EOF" > temp_patch.mm
        #include <spawn.h>
        #include <sys/wait.h>
        #include <cstdio>
        #include <cstring>

        extern char **environ;

        int execute_posix_command(NSString *command);
        EOF
        
        # Insert after existing includes
        sed -i '' '/#include/r temp_patch.mm' zxtouch-binary/main.mm
        rm temp_patch.mm

        # Fix 3: Add function implementation
        cat << "EOF" >> zxtouch-binary/main.mm

        int execute_posix_command(NSString *command) {
            pid_t pid;
            const char *cmd = [command UTF8String];
            char *const argv[] = {(char *)"sh", (char *)"-c", (char *)cmd, NULL};
            posix_spawnattr_t attr;
            
            posix_spawnattr_init(&attr);
            posix_spawnattr_setflags(&attr, POSIX_SPAWN_SETSIGDEF | POSIX_SPAWN_SETSIGMASK);
            sigset_t all_signals;
            sigfillset(&all_signals);
            posix_spawnattr_setsigmask(&attr, &all_signals);
            sigemptyset(&all_signals);
            posix_spawnattr_setsigdefault(&attr, &all_signals);
            
            int status = posix_spawn(&pid, "/bin/sh", NULL, &attr, argv, environ);
            if (status == 0) {
                if (waitpid(pid, &status, 0) == -1) {
                    perror("waitpid");
                }
            } else {
                printf("posix_spawn failed: %s\n", strerror(status));
            }
            posix_spawnattr_destroy(&attr);
            return status;
        }
        EOF

        # Fix 4: Remove unused variable
        sed -i '' 's/int sock = 0, valread;/int sock = 0;/g' zxtouch-binary/main.mm
        
        # Fix 5: Remove unsupported arm64e
        sed -i '' 's/ARCHS = armv7 arm64 arm64e/ARCHS = armv7 arm64/g' zxtouch-binary/Makefile
        EOS

        chmod +x patch_zxtouch.sh

    - name: Patch zxtouch-binary
      run: ./patch_zxtouch.sh

    # ... following steps ...
    - name: Build package
      run: |
        make clean
        make package \
          THEOS="${THEOS}" \
          SDKROOT="${SDKROOT}" \
          OpenCV_INCLUDE_DIR="${OpenCV_INCLUDE_DIR}" \
          FINALPACKAGE="${FINALPACKAGE}" \
          THEOS_PACKAGE_SCHEME="${THEOS_PACKAGE_SCHEME}"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: IOS13-SimulateTouch
        path: packages/*.deb