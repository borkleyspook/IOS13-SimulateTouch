name: Build Jailbreak Tweak

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest  # Theos works best on Linux
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Theos
      run: |
        # Install required dependencies
        sudo apt-get update
        sudo apt-get install -y git clang curl libxml2-dev libssl-dev python3-dev \
                               fakeroot dpkg-dev libncurses5-dev
        
        # Install Theos
        git clone --depth=1 https://github.com/theos/theos.git "${HOME}/theos"
        echo "THEOS=${HOME}/theos" >> $GITHUB_ENV
        
        # Install iOS toolchain
        curl -LO https://github.com/theos/sdks/archive/refs/heads/master.zip
        unzip master.zip
        mv sdks-master/*.sdk "${HOME}/theos/sdks"
        chmod -R 755 "${HOME}/theos/sdks"
        
        # Install ldid for fake code signing
        curl -LO https://github.com/ProcursusTeam/ldid/releases/download/v2.1.5-procursus7/ldid_macosx_x86_64
        mv ldid_macosx_x86_64 ldid
        chmod +x ldid
        sudo mv ldid /usr/local/bin/

    - name: Build tweak
      run: |
        # Set Theos environment variables
        export THEOS=${HOME}/theos
        export SDKROOT=${THEOS}/sdks/iPhoneOS14.5.sdk
        export ARCHS=arm64
        export TARGET=iphone:clang:latest:13.0
        
        # Navigate to project directory
        cd IOS13-SimulateTouch
        
        # Build the tweak and create deb package
        make package FINALPACKAGE=1

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: IOS13-SimulateTouch.deb
        path: IOS13-SimulateTouch/packages/*.deb